name: Approve and Apply GKE Cluster

on:
  workflow_dispatch:
    inputs:
      cluster_name:
        description: 'GKE Cluster name'
        required: true
      project_id:
        description: 'GCP Project ID'
        required: true
      region:
        description: 'GCP Region'
        required: true
      port_context:
        description: 'Port context object (includes runId)'
        required: true

permissions:
  contents: write
  pull-requests: write
  actions: read

env:
  TF_REPO: matar-Port-demo/create-iam-role
  BASE_TF_DIR: resources
  MAIN_BRANCH: main

jobs:
  approve-and-apply:
    runs-on: ubuntu-latest
    steps:
      - name: Extract Port Run ID and Approver
        id: extract_run_id_and_approver
        run: |
          PORT_RUN_ID="${{ fromJson(github.event.inputs.port_context).runId }}"
          APPROVER_EMAIL="${{ fromJson(github.event.inputs.port_context).approverEmail }}"
          echo "PORT_RUN_ID=$PORT_RUN_ID" >> $GITHUB_ENV
          echo "APPROVER_EMAIL=$APPROVER_EMAIL" >> $GITHUB_ENV
          echo "::set-output name=PORT_RUN_ID::$PORT_RUN_ID"
          echo "::set-output name=APPROVER_EMAIL::$APPROVER_EMAIL"

      - name: Get PR URL from provisioning request entity
        id: get_pr_url
        uses: port-labs/port-github-action@v1
        with:
          clientId: ${{ secrets.PORT_CLIENT_ID }}
          clientSecret: ${{ secrets.PORT_CLIENT_SECRET }}
          baseUrl: https://api.getport.io
          operation: GET
          identifier: ${{ env.PORT_RUN_ID }}
          blueprint: provisioningRequest
        
      - name: Extract PR URL
        id: extract_pr_url
        run: |
          ENTITY='${{ steps.get_pr_url.outputs.entity }}'
          
          # Extract pr_url from entity properties
          PR_URL=$(echo "$ENTITY" | jq -r '.properties.pr_url // empty')
          
          if [ -z "$PR_URL" ] || [ "$PR_URL" == "null" ]; then
            echo "‚ùå Error: Could not find PR URL in provisioning request entity"
            echo "Entity data: $ENTITY"
            exit 1
          fi
          
          echo "‚úÖ Found PR URL: $PR_URL"
          echo "PR_URL=$PR_URL" >> $GITHUB_ENV
          echo "::set-output name=PR_URL::$PR_URL"

      - name: Build approver relations JSON
        id: build_approver_relations
        run: |
          APPROVER_EMAIL="${{ env.APPROVER_EMAIL }}"
          
          # Build relations JSON (only approver if available)
          RELATIONS_JSON=$(jq -n \
            --arg approver_email "$APPROVER_EMAIL" \
            'if $approver_email != "" and $approver_email != "null" then {"approver": $approver_email} else {} end')
          
          echo "RELATIONS_JSON<<EOF" >> $GITHUB_OUTPUT
          echo "$RELATIONS_JSON" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Update provisioning request status to approved
        uses: port-labs/port-github-action@v1
        with:
          clientId: ${{ secrets.PORT_CLIENT_ID }}
          clientSecret: ${{ secrets.PORT_CLIENT_SECRET }}
          baseUrl: https://api.getport.io
          operation: UPSERT
          identifier: ${{ env.PORT_RUN_ID }}
          blueprint: provisioningRequest
          runId: ${{ env.PORT_RUN_ID }}
          properties: |
            {
              "status": "approved"
            }

      - name: Update provisioning request with approver relation
        if: env.APPROVER_EMAIL != '' && env.APPROVER_EMAIL != 'null'
        uses: port-labs/port-github-action@v1
        with:
          clientId: ${{ secrets.PORT_CLIENT_ID }}
          clientSecret: ${{ secrets.PORT_CLIENT_SECRET }}
          baseUrl: https://api.getport.io
          operation: UPSERT
          identifier: ${{ env.PORT_RUN_ID }}
          blueprint: provisioningRequest
          runId: ${{ env.PORT_RUN_ID }}
          relations: ${{ steps.build_approver_relations.outputs.RELATIONS_JSON }}

      - name: Extract PR number from URL
        id: extract_pr_number
        run: |
          PR_NUMBER=$(echo "${{ env.PR_URL }}" | grep -oE '/pull/[0-9]+' | grep -oE '[0-9]+')
          echo "Extracted PR Number: $PR_NUMBER"
          echo "PR_NUMBER=$PR_NUMBER" >> $GITHUB_ENV
          echo "::set-output name=PR_NUMBER::$PR_NUMBER"

      - name: Log approval start to original run
        uses: port-labs/port-github-action@v1
        with:
          clientId: ${{ secrets.PORT_CLIENT_ID }}
          clientSecret: ${{ secrets.PORT_CLIENT_SECRET }}
          baseUrl: https://api.getport.io
          operation: PATCH_RUN
          runId: ${{ env.PORT_RUN_ID }}
          logMessage: "‚úÖ Approval received! Starting merge and Terraform apply..."

      - name: Checkout Terraform Repo
        uses: actions/checkout@v3
        with:
          repository: ${{ env.TF_REPO }}
          token: ${{ secrets.GH_PAT }}

      - name: Merge Pull Request
        run: |
          gh pr merge ${{ env.PR_NUMBER }} --admin --squash
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}

      - name: Log merge completion
        uses: port-labs/port-github-action@v1
        with:
          clientId: ${{ secrets.PORT_CLIENT_ID }}
          clientSecret: ${{ secrets.PORT_CLIENT_SECRET }}
          baseUrl: https://api.getport.io
          operation: PATCH_RUN
          runId: ${{ env.PORT_RUN_ID }}
          logMessage: "üîÄ PR merged successfully"

      - name: Pull latest main branch
        run: |
          git checkout main
          git pull origin main

      - name: Update provisioning request status to applying
        uses: port-labs/port-github-action@v1
        with:
          clientId: ${{ secrets.PORT_CLIENT_ID }}
          clientSecret: ${{ secrets.PORT_CLIENT_SECRET }}
          baseUrl: https://api.getport.io
          operation: UPSERT
          identifier: ${{ env.PORT_RUN_ID }}
          blueprint: provisioningRequest
          runId: ${{ env.PORT_RUN_ID }}
          properties: |
            {
              "status": "applying"
            }

      - name: Generate Mock Terraform Apply Output
        id: mock_apply
        run: |
          CLUSTER_NAME="${{ github.event.inputs.cluster_name }}"
          PROJECT_ID="${{ github.event.inputs.project_id }}"
          REGION="${{ github.event.inputs.region }}"
          
          cat > apply_output.txt <<EOF
          google_container_cluster.cluster: Creating...
          google_container_cluster.cluster: Still creating... [10s elapsed]
          google_container_cluster.cluster: Still creating... [20s elapsed]
          google_container_cluster.cluster: Still creating... [30s elapsed]
          google_container_cluster.cluster: Still creating... [40s elapsed]
          google_container_cluster.cluster: Creation complete after 45s [id=projects/$PROJECT_ID/locations/$REGION/clusters/$CLUSTER_NAME]

          Apply complete! Resources: 1 added, 0 changed, 0 destroyed.

          Outputs:

          cluster_endpoint = "https://$CLUSTER_NAME.$REGION.gke.cloud.google.com"
          cluster_name = "$CLUSTER_NAME"
          cluster_region = "$REGION"
          EOF
          
          APPLY_OUTPUT=$(cat apply_output.txt)
          echo "APPLY_OUTPUT<<EOF" >> $GITHUB_ENV
          echo "$APPLY_OUTPUT" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Log Terraform Apply to Port
        uses: port-labs/port-github-action@v1
        with:
          clientId: ${{ secrets.PORT_CLIENT_ID }}
          clientSecret: ${{ secrets.PORT_CLIENT_SECRET }}
          baseUrl: https://api.getport.io
          operation: PATCH_RUN
          runId: ${{ env.PORT_RUN_ID }}
          logMessage: |
            üîß **Terraform Apply Output:**
            
            ```
            ${{ env.APPLY_OUTPUT }}
            ```

      # NOTE: Actual Terraform apply is commented out since GCP account is not available
      # Uncomment the following steps when GCP credentials are configured:
      #
      # - name: Set up Terraform
      #   uses: hashicorp/setup-terraform@v2
      #   with:
      #     terraform_version: 1.5.7
      #
      # - name: Authenticate to Google Cloud
      #   uses: google-github-actions/auth@v1
      #   with:
      #     credentials_json: ${{ secrets.GCP_SA_KEY }}
      #
      # - name: Set up Cloud SDK
      #   uses: google-github-actions/setup-gcloud@v1
      #
      # - name: Terraform Init & Apply
      #   env:
      #     GOOGLE_PROJECT: ${{ github.event.inputs.project_id }}
      #   run: |
      #     CLUSTER_NAME="${{ github.event.inputs.cluster_name }}"
      #     TF_DIR="${{ env.BASE_TF_DIR }}/$CLUSTER_NAME"
      #     cd "$TF_DIR"
      #     terraform init
      #     terraform apply -auto-approve

      - name: Update provisioning request status to completed
        uses: port-labs/port-github-action@v1
        with:
          clientId: ${{ secrets.PORT_CLIENT_ID }}
          clientSecret: ${{ secrets.PORT_CLIENT_SECRET }}
          baseUrl: https://api.getport.io
          operation: UPSERT
          identifier: ${{ env.PORT_RUN_ID }}
          blueprint: provisioningRequest
          runId: ${{ env.PORT_RUN_ID }}
          properties: |
            {
              "status": "completed"
            }

      - name: Update provisioning request status to declined on failure
        if: failure()
        uses: port-labs/port-github-action@v1
        with:
          clientId: ${{ secrets.PORT_CLIENT_ID }}
          clientSecret: ${{ secrets.PORT_CLIENT_SECRET }}
          baseUrl: https://api.getport.io
          operation: UPSERT
          identifier: ${{ env.PORT_RUN_ID }}
          blueprint: provisioningRequest
          runId: ${{ env.PORT_RUN_ID }}
          properties: |
            {
              "status": "declined"
            }

      - name: Finalize original run
        uses: port-labs/port-github-action@v1
        with:
          clientId: ${{ secrets.PORT_CLIENT_ID }}
          clientSecret: ${{ secrets.PORT_CLIENT_SECRET }}
          baseUrl: https://api.getport.io
          operation: PATCH_RUN
          runId: ${{ env.PORT_RUN_ID }}
          status: "SUCCESS"
          summary: "‚úÖ GKE cluster `${{ github.event.inputs.cluster_name }}` created successfully"
          logMessage: "üåç Terraform applied successfully. GKE cluster is ready!"
          link: "[\"https://console.cloud.google.com/kubernetes/clusters/details/${{ github.event.inputs.region }}/${{ github.event.inputs.cluster_name }}?project=${{ github.event.inputs.project_id }}\", \"${{ env.PR_URL }}\"]"

