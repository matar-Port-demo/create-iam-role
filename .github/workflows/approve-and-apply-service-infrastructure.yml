name: Approve and Apply Service Infrastructure

on:
  workflow_dispatch:
    inputs:
      application_name:
        description: 'Application name'
        required: true
      stack_type:
        description: 'Stack type'
        required: true
      description:
        description: 'Service description'
        required: false
      runtime:
        description: 'Runtime'
        required: false
      database_setup:
        description: 'Database setup option'
        required: false
      k_8_s_setup:
        description: 'K8s setup option'
        required: false
      port_context:
        description: 'Port context object (includes runId)'
        required: true

permissions:
  contents: write
  pull-requests: write
  actions: read

env:
  TF_REPO: db-hackathon/app-deployment-repo
  BASE_TF_DIR: resources
  MAIN_BRANCH: main

jobs:
  approve-and-apply:
    runs-on: ubuntu-latest
    steps:
      - name: Extract Port Run ID and Approver
        id: extract_run_id_and_approver
        run: |
          PORT_RUN_ID="${{ fromJson(github.event.inputs.port_context).runId }}"
          APPROVER_EMAIL="${{ fromJson(github.event.inputs.port_context).approverEmail }}"
          echo "PORT_RUN_ID=$PORT_RUN_ID" >> $GITHUB_ENV
          echo "APPROVER_EMAIL=$APPROVER_EMAIL" >> $GITHUB_ENV
          echo "PORT_RUN_ID=$PORT_RUN_ID" >> $GITHUB_OUTPUT

      - name: Get provisioning request entity
        id: get_provisioning_request
        uses: port-labs/port-github-action@v1
        with:
          clientId: ${{ secrets.PORT_CLIENT_ID }}
          clientSecret: ${{ secrets.PORT_CLIENT_SECRET }}
          baseUrl: https://api.getport.io
          operation: GET
          identifier: ${{ env.PORT_RUN_ID }}
          blueprint: provisioningRequest
        continue-on-error: true

      - name: Check if entity exists
        run: |
          echo "Checking if entity exists for Run ID: ${{ env.PORT_RUN_ID }}"
          ENTITY_JSON='${{ steps.get_provisioning_request.outputs.entity }}'
          echo "Entity output: $ENTITY_JSON"
          
          if [ -z "$ENTITY_JSON" ] || [ "$ENTITY_JSON" == "null" ] || [ "$ENTITY_JSON" == "" ]; then
            echo "‚ùå Error: Could not retrieve provisioning request entity"
            echo "Run ID: ${{ env.PORT_RUN_ID }}"
            echo "This might mean the entity doesn't exist yet or the GET operation failed."
            exit 1
          fi
          
          echo "‚úÖ Successfully retrieved entity"
          echo "Entity identifier: $(echo "$ENTITY_JSON" | jq -r '.identifier // "unknown"')"
        env:
          ENTITY_JSON: ${{ steps.get_provisioning_request.outputs.entity }}

      - name: Extract PR URLs from entity
        id: extract_pr_urls
        run: |
          # Extract PR URLs from entity (separate properties, not array)
          INFRA_PR_URL=$(echo "$ENTITY_JSON" | jq -r '.properties.pr_url // empty')
          CICD_PR_URL=$(echo "$ENTITY_JSON" | jq -r '.properties.cicd_pr_url // empty')
          SERVICE_REPO_URL=$(echo "$ENTITY_JSON" | jq -r '.properties.service_repo_url // empty')
          
          if [ -z "$INFRA_PR_URL" ] || [ "$INFRA_PR_URL" == "null" ] || [ "$INFRA_PR_URL" == "" ]; then
            echo "‚ùå Error: No infrastructure PR URL found in provisioning request entity"
            echo "Entity properties: $(echo "$ENTITY_JSON" | jq '.properties')"
            exit 1
          fi
          
          echo "‚úÖ Found infrastructure PR URL: $INFRA_PR_URL"
          if [ -n "$CICD_PR_URL" ] && [ "$CICD_PR_URL" != "null" ] && [ "$CICD_PR_URL" != "" ]; then
            echo "‚úÖ Found CI/CD PR URL: $CICD_PR_URL"
          fi
          
          echo "INFRA_PR_URL=$INFRA_PR_URL" >> $GITHUB_ENV
          echo "CICD_PR_URL=$CICD_PR_URL" >> $GITHUB_ENV
          echo "SERVICE_REPO_URL=$SERVICE_REPO_URL" >> $GITHUB_ENV
          
          # Extract PR numbers
          INFRA_PR_NUMBER=$(echo "$INFRA_PR_URL" | grep -oE '/pull/[0-9]+' | grep -oE '[0-9]+' || echo "")
          if [ -n "$CICD_PR_URL" ] && [ "$CICD_PR_URL" != "null" ] && [ "$CICD_PR_URL" != "" ]; then
            CICD_PR_NUMBER=$(echo "$CICD_PR_URL" | grep -oE '/pull/[0-9]+' | grep -oE '[0-9]+' || echo "")
          else
            CICD_PR_NUMBER=""
          fi
          
          echo "INFRA_PR_NUMBER=$INFRA_PR_NUMBER" >> $GITHUB_ENV
          echo "CICD_PR_NUMBER=$CICD_PR_NUMBER" >> $GITHUB_ENV
          
          # Extract repository from PR URL (format: https://github.com/owner/repo/pull/123)
          if [ -n "$INFRA_PR_URL" ]; then
            SERVICE_REPO=$(echo "$INFRA_PR_URL" | sed -E 's|https://github.com/([^/]+/[^/]+)/pull/.*|\1|')
            echo "SERVICE_REPO=$SERVICE_REPO" >> $GITHUB_ENV
          fi
          
          if [ -z "$INFRA_PR_NUMBER" ]; then
            echo "‚ùå Error: Could not extract infrastructure PR number"
            exit 1
          fi
          
          echo "‚úÖ Extracted PR numbers - Infrastructure: $INFRA_PR_NUMBER, CI/CD: $CICD_PR_NUMBER"
        env:
          ENTITY_JSON: ${{ steps.get_provisioning_request.outputs.entity }}

      - name: Update provisioning request status to approved
        uses: port-labs/port-github-action@v1
        with:
          clientId: ${{ secrets.PORT_CLIENT_ID }}
          clientSecret: ${{ secrets.PORT_CLIENT_SECRET }}
          baseUrl: https://api.getport.io
          operation: UPSERT
          identifier: ${{ env.PORT_RUN_ID }}
          blueprint: provisioningRequest
          runId: ${{ env.PORT_RUN_ID }}
          properties: |
            {
              "status": "approved"
            }

      - name: Log approval start to Port
        uses: port-labs/port-github-action@v1
        with:
          clientId: ${{ secrets.PORT_CLIENT_ID }}
          clientSecret: ${{ secrets.PORT_CLIENT_SECRET }}
          baseUrl: https://api.getport.io
          operation: PATCH_RUN
          runId: ${{ env.PORT_RUN_ID }}
          logMessage: "‚úÖ Approval received! Starting infrastructure provisioning and service creation..."

      - name: Checkout Service Repository
        uses: actions/checkout@v3
        with:
          repository: ${{ env.SERVICE_REPO }}
          token: ${{ secrets.GH_PAT }}

      - name: Generate Mock Terraform Apply Output
        id: mock_apply
        run: |
          APP_NAME="${{ github.event.inputs.application_name }}"
          STACK_TYPE="${{ github.event.inputs.stack_type }}"
          K8S_SETUP="${{ github.event.inputs.k_8_s_setup }}"
          DB_SETUP="${{ github.event.inputs.database_setup }}"
          
          APPLY_FILE=$(mktemp)
          RESOURCE_COUNT=0
          
          if [ "$STACK_TYPE" = "Containerized (GKE)" ] && [ "$K8S_SETUP" = "Create a new Cluster" ]; then
            echo "google_container_cluster.cluster: Creating..." >> "$APPLY_FILE"
            echo "google_container_cluster.cluster: Still creating... [10s elapsed]" >> "$APPLY_FILE"
            echo "google_container_cluster.cluster: Still creating... [20s elapsed]" >> "$APPLY_FILE"
            echo "google_container_cluster.cluster: Still creating... [30s elapsed]" >> "$APPLY_FILE"
            echo "google_container_cluster.cluster: Creation complete after 45s [id=projects/PROJECT_ID/locations/us-central1/clusters/$APP_NAME-cluster]" >> "$APPLY_FILE"
            echo "" >> "$APPLY_FILE"
            RESOURCE_COUNT=$((RESOURCE_COUNT + 1))
          fi
          
          if [ "$DB_SETUP" = "Create a new database" ]; then
            echo "google_sql_database_instance.database: Creating..." >> "$APPLY_FILE"
            echo "google_sql_database_instance.database: Still creating... [30s elapsed]" >> "$APPLY_FILE"
            echo "google_sql_database_instance.database: Still creating... [60s elapsed]" >> "$APPLY_FILE"
            echo "google_sql_database_instance.database: Creation complete after 90s [id=projects/PROJECT_ID/instances/$APP_NAME-db]" >> "$APPLY_FILE"
            echo "" >> "$APPLY_FILE"
            RESOURCE_COUNT=$((RESOURCE_COUNT + 1))
          fi
          
          echo "Apply complete! Resources: $RESOURCE_COUNT added, 0 changed, 0 destroyed." >> "$APPLY_FILE"
          
          APPLY_OUTPUT=$(cat "$APPLY_FILE")
          rm "$APPLY_FILE"
          
          echo "APPLY_OUTPUT<<EOF" >> $GITHUB_ENV
          echo "$APPLY_OUTPUT" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Log Terraform Apply to Port
        uses: port-labs/port-github-action@v1
        with:
          clientId: ${{ secrets.PORT_CLIENT_ID }}
          clientSecret: ${{ secrets.PORT_CLIENT_SECRET }}
          baseUrl: https://api.getport.io
          operation: PATCH_RUN
          runId: ${{ env.PORT_RUN_ID }}
          logMessage: |
            üîß **Terraform Apply Output:**
            
            ```
            ${{ env.APPLY_OUTPUT }}
            ```
            
            ‚úÖ Infrastructure provisioned successfully!

      - name: Merge Infrastructure Pull Request
        run: |
          gh pr merge ${{ env.INFRA_PR_NUMBER }} --admin --squash
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}

      - name: Log infrastructure PR merge
        uses: port-labs/port-github-action@v1
        with:
          clientId: ${{ secrets.PORT_CLIENT_ID }}
          clientSecret: ${{ secrets.PORT_CLIENT_SECRET }}
          baseUrl: https://api.getport.io
          operation: PATCH_RUN
          runId: ${{ env.PORT_RUN_ID }}
          logMessage: "üîÄ Infrastructure PR merged successfully"

      - name: Merge CI/CD PR
        if: env.CICD_PR_NUMBER != '' && env.CICD_PR_NUMBER != 'null'
        run: |
          gh pr merge ${{ env.CICD_PR_NUMBER }} --admin --squash
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}

      - name: Log CI/CD PR merge
        if: env.CICD_PR_NUMBER != '' && env.CICD_PR_NUMBER != 'null'
        uses: port-labs/port-github-action@v1
        with:
          clientId: ${{ secrets.PORT_CLIENT_ID }}
          clientSecret: ${{ secrets.PORT_CLIENT_SECRET }}
          baseUrl: https://api.getport.io
          operation: PATCH_RUN
          runId: ${{ env.PORT_RUN_ID }}
          logMessage: "üîÄ CI/CD PR merged successfully"

      - name: Create Cluster Entity (if created)
        if: github.event.inputs.stack_type == 'Containerized (GKE)' && github.event.inputs.k_8_s_setup == 'Create a new Cluster'
        uses: port-labs/port-github-action@v1
        with:
          clientId: ${{ secrets.PORT_CLIENT_ID }}
          clientSecret: ${{ secrets.PORT_CLIENT_SECRET }}
          baseUrl: https://api.getport.io
          operation: UPSERT
          identifier: ${{ github.event.inputs.application_name }}-cluster
          title: "${{ github.event.inputs.application_name }}-cluster"
          blueprint: gkeCluster
          runId: ${{ env.PORT_RUN_ID }}
          properties: |
            {
              "cluster_name": "${{ github.event.inputs.application_name }}-cluster",
              "cluster_type": "GKE",
              "region": "us-central1",
              "gke_version": "latest",
              "node_count": 3,
              "status": "active"
            }

      - name: Create Database Entity (if created)
        if: github.event.inputs.database_setup == 'Create a new database'
        uses: port-labs/port-github-action@v1
        with:
          clientId: ${{ secrets.PORT_CLIENT_ID }}
          clientSecret: ${{ secrets.PORT_CLIENT_SECRET }}
          baseUrl: https://api.getport.io
          operation: UPSERT
          identifier: ${{ github.event.inputs.application_name }}-db
          title: "${{ github.event.inputs.application_name }}-db"
          blueprint: database
          runId: ${{ env.PORT_RUN_ID }}
          properties: |
            {
              "database_name": "${{ github.event.inputs.application_name }}-db",
              "database_type": "CloudSQL",
              "database_version": "POSTGRES_14",
              "region": "us-central1",
              "status": "active"
            }

      - name: Set repository identifier
        id: set_repo_id
        run: |
          # Use SERVICE_REPO which is already in owner/repo format (extracted from PR URL)
          # If SERVICE_REPO is not available, construct from known values
          if [ -n "${{ env.SERVICE_REPO }}" ] && [ "${{ env.SERVICE_REPO }}" != "null" ] && [ "${{ env.SERVICE_REPO }}" != "" ]; then
            REPO_ID="${{ env.SERVICE_REPO }}"
          else
            # Fallback: construct from application name and repository owner
            APP_NAME="${{ github.event.inputs.application_name }}"
            REPO_OWNER="${{ github.repository_owner }}"
            REPO_ID="$REPO_OWNER/$APP_NAME"
          fi
          echo "REPO_ID=$REPO_ID" >> $GITHUB_ENV
          echo "repo_identifier=$REPO_ID" >> $GITHUB_OUTPUT
          echo "‚úÖ Repository identifier: $REPO_ID"

      - name: Build service relations JSON
        id: build_service_relations
        run: |
          APP_NAME="${{ github.event.inputs.application_name }}"
          REPO_ID="${{ env.REPO_ID }}"
          
          # Start with repository relation (required)
          if [ -z "$REPO_ID" ] || [ "$REPO_ID" == "null" ] || [ "$REPO_ID" == "" ]; then
            echo "‚ùå Error: Repository identifier is empty"
            echo "SERVICE_REPO_URL: ${{ env.SERVICE_REPO_URL }}"
            exit 1
          fi
          
          RELATIONS=$(jq -n \
            --arg repo "$REPO_ID" \
            '{"repository": $repo}')
          
          # Add cluster relation if created
          if [ "${{ github.event.inputs.stack_type }}" = "Containerized (GKE)" ] && [ "${{ github.event.inputs.k_8_s_setup }}" = "Create a new Cluster" ]; then
            RELATIONS=$(echo "$RELATIONS" | jq --arg cluster "${APP_NAME}-cluster" '. + {"cluster": $cluster}')
          fi
          
          # Add database relation if created
          if [ "${{ github.event.inputs.database_setup }}" = "Create a new database" ]; then
            RELATIONS=$(echo "$RELATIONS" | jq --arg db "${APP_NAME}-db" '. + {"database": $db}')
          fi
          
          echo "‚úÖ Built relations: $RELATIONS"
          echo "RELATIONS<<EOF" >> $GITHUB_OUTPUT
          echo "$RELATIONS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
        env:
          REPO_ID: ${{ env.REPO_ID }}

      - name: Create Service Entity
        uses: port-labs/port-github-action@v1
        with:
          clientId: ${{ secrets.PORT_CLIENT_ID }}
          clientSecret: ${{ secrets.PORT_CLIENT_SECRET }}
          baseUrl: https://api.getport.io
          operation: UPSERT
          identifier: ${{ github.event.inputs.application_name }}
          title: "${{ github.event.inputs.application_name }}"
          blueprint: db_service
          runId: ${{ env.PORT_RUN_ID }}
          properties: |
            {
              "name": "${{ github.event.inputs.application_name }}",
              "description": "${{ github.event.inputs.description }}",
              "stack_type": "${{ github.event.inputs.stack_type }}",
              "runtime": "${{ github.event.inputs.runtime }}",
              "status": "active"
            }
          relations: ${{ steps.build_service_relations.outputs.RELATIONS }}

      - name: Log service creation to Port
        uses: port-labs/port-github-action@v1
        with:
          clientId: ${{ secrets.PORT_CLIENT_ID }}
          clientSecret: ${{ secrets.PORT_CLIENT_SECRET }}
          baseUrl: https://api.getport.io
          operation: PATCH_RUN
          runId: ${{ env.PORT_RUN_ID }}
          logMessage: "‚úÖ Service entity created successfully with all relations"

      - name: Update provisioning request status to completed
        uses: port-labs/port-github-action@v1
        with:
          clientId: ${{ secrets.PORT_CLIENT_ID }}
          clientSecret: ${{ secrets.PORT_CLIENT_SECRET }}
          baseUrl: https://api.getport.io
          operation: UPSERT
          identifier: ${{ env.PORT_RUN_ID }}
          blueprint: provisioningRequest
          runId: ${{ env.PORT_RUN_ID }}
          properties: |
            {
              "status": "completed"
            }

      - name: Build final run links
        id: build_final_links
        run: |
          LINKS=()
          
          # Add service repo URL if available
          if [ -n "${{ env.SERVICE_REPO_URL }}" ] && [ "${{ env.SERVICE_REPO_URL }}" != "null" ] && [ "${{ env.SERVICE_REPO_URL }}" != "" ]; then
            LINKS+=("${{ env.SERVICE_REPO_URL }}")
          fi
          
          # Add infrastructure PR URL if available
          if [ -n "${{ env.INFRA_PR_URL }}" ] && [ "${{ env.INFRA_PR_URL }}" != "null" ] && [ "${{ env.INFRA_PR_URL }}" != "" ]; then
            LINKS+=("${{ env.INFRA_PR_URL }}")
          fi
          
          # Build JSON array
          if [ ${#LINKS[@]} -eq 0 ]; then
            LINKS_JSON="[]"
          else
            LINKS_JSON=$(printf '%s\n' "${LINKS[@]}" | jq -R . | jq -s .)
          fi
          
          echo "LINKS_JSON<<EOF" >> $GITHUB_OUTPUT
          echo "$LINKS_JSON" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "‚úÖ Built links: $LINKS_JSON"

      - name: Finalize Port run
        uses: port-labs/port-github-action@v1
        with:
          clientId: ${{ secrets.PORT_CLIENT_ID }}
          clientSecret: ${{ secrets.PORT_CLIENT_SECRET }}
          baseUrl: https://api.getport.io
          operation: PATCH_RUN
          runId: ${{ env.PORT_RUN_ID }}
          status: "SUCCESS"
          summary: "‚úÖ Service `${{ github.event.inputs.application_name }}` created successfully"
          logMessage: "üéâ Service creation complete! Infrastructure provisioned, CI/CD configured, and service entity created."
          link: ${{ steps.build_final_links.outputs.LINKS_JSON }}

