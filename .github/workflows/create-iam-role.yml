name: Create IAM Role

on:
  workflow_dispatch:
    inputs:
      PORT_RUN_ID:
        description: 'Port Run ID'
        required: true
      ROLE_NAME:
        description: 'IAM Role name'
        required: true
      POLICY_JSON:
        description: 'IAM policy JSON (escaped)'
        required: true

env:
  TF_REPO: my-org/terraform-repo
  TF_DIR: resources
  BRANCH_PREFIX: create-iam
  MAIN_BRANCH: main

jobs:
  start:
    runs-on: ubuntu-latest
    steps:
      - name: Log start to Port
        uses: port-labs/port-github-action@v1
        with:
          clientId: ${{ secrets.PORT_CLIENT_ID }}
          clientSecret: ${{ secrets.PORT_CLIENT_SECRET }}
          baseUrl: ${{ secrets.PORT_BASE_URL }}
          operation: PATCH_RUN
          runId: ${{ github.event.inputs.PORT_RUN_ID }}
          logMessage: "üöÄ Starting IAM role creation for ${{ github.event.inputs.ROLE_NAME }}"

  create-pr:
    runs-on: ubuntu-latest
    needs: start
    outputs:
      pr_url: ${{ steps.create_pr.outputs.pull-request-url }}
    steps:
      - uses: actions/checkout@v3

      - name: Checkout Terraform Repo
        uses: actions/checkout@v3
        with:
          repository: ${{ env.TF_REPO }}
          token: ${{ secrets.GITHUB_TOKEN }}
          path: tfrepo

      - name: Prepare IAM Role File
        run: |
          mkdir -p tfrepo/${{ env.TF_DIR }}
          TEMPLATE=$(<templates/iam-role.tf)
          ESCAPED_POLICY=$(echo "${{ github.event.inputs.POLICY_JSON }}" | base64 --decode)

          IAM_FILE="tfrepo/${{ env.TF_DIR }}/${{ github.event.inputs.ROLE_NAME }}.tf"
          echo "${TEMPLATE//\{\{ role_name \}\}/${{ github.event.inputs.ROLE_NAME }}}" | \
            sed "s|{{ policy_json }}|$ESCAPED_POLICY|" > $IAM_FILE

      - name: Create Pull Request
        id: create_pr
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "Add IAM role ${{ github.event.inputs.ROLE_NAME }}"
          branch: ${{ env.BRANCH_PREFIX }}-${{ github.run_id }}
          base: ${{ env.MAIN_BRANCH }}
          title: "Create IAM role ${{ github.event.inputs.ROLE_NAME }}"
          body: "This PR adds the IAM role via Terraform."

      - name: Log PR to Port
        uses: port-labs/port-github-action@v1
        with:
          clientId: ${{ secrets.PORT_CLIENT_ID }}
          clientSecret: ${{ secrets.PORT_CLIENT_SECRET }}
          baseUrl: ${{ secrets.PORT_BASE_URL }}
          operation: PATCH_RUN
          runId: ${{ github.event.inputs.PORT_RUN_ID }}
          logMessage: "üì• Created PR to add IAM role"
          link: "[\"${{ steps.create_pr.outputs.pull-request-url }}\"]"

  merge-and-apply:
    runs-on: ubuntu-latest
    needs: create-pr
    steps:
      - name: Checkout Terraform Repo
        uses: actions/checkout@v3
        with:
          repository: ${{ env.TF_REPO }}
          token: ${{ secrets.GITHUB_TOKEN }}
          path: tfrepo

      - name: Merge Pull Request
        run: |
          gh pr merge --admin --squash "${{ needs.create-pr.outputs.pr_url }}"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Terraform Init & Apply
        run: |
          cd tfrepo
          terraform init
          terraform plan
          terraform apply -auto-approve

      - name: Finalize in Port
        uses: port-labs/port-github-action@v1
        with:
          clientId: ${{ secrets.PORT_CLIENT_ID }}
          clientSecret: ${{ secrets.PORT_CLIENT_SECRET }}
          baseUrl: ${{ secrets.PORT_BASE_URL }}
          operation: PATCH_RUN
          runId: ${{ github.event.inputs.PORT_RUN_ID }}
          status: "SUCCESS"
          summary: "‚úÖ IAM role created successfully"
          logMessage: "üåç Terraform applied IAM role"
          link: "[\"${{ needs.create-pr.outputs.pr_url }}\"]"
